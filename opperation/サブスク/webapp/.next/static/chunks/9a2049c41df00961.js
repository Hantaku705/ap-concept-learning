(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,57951,e=>{"use strict";var t=e.i(43476),r=e.i(71645);let a=(0,r.createContext)(void 0),l="subscription_tracker_auth";function i({children:e}){let[i,o]=(0,r.useState)({isAuthenticated:!1,isLoading:!0,tokens:null,userEmail:null,error:null});(0,r.useEffect)(()=>{let e=localStorage.getItem(l);if(e)try{let{tokens:t,userEmail:r}=JSON.parse(e);if(t&&t.expiresAt>Date.now())return void o({isAuthenticated:!0,isLoading:!1,tokens:t,userEmail:r,error:null})}catch(e){console.error("Failed to parse auth from storage",e)}o(e=>({...e,isLoading:!1}))},[]);let s=(0,r.useCallback)(()=>{window.location.href="/api/auth/login"},[]),n=(0,r.useCallback)(()=>{localStorage.removeItem(l),o({isAuthenticated:!1,isLoading:!1,tokens:null,userEmail:null,error:null})},[]),c=(0,r.useCallback)((e,t)=>{localStorage.setItem(l,JSON.stringify({tokens:e,userEmail:t})),o({isAuthenticated:!0,isLoading:!1,tokens:e,userEmail:t,error:null})},[]);return(0,t.jsx)(a.Provider,{value:{...i,login:s,logout:n,setTokens:c},children:e})}function o(){let e=(0,r.useContext)(a);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}e.s(["AuthProvider",()=>i,"useAuth",()=>o])},50623,e=>{"use strict";var t=e.i(43476),r=e.i(71645),a=e.i(57951);let l=(0,r.createContext)(void 0),i="subscription_tracker_data",o=e=>`subscription_data_${e}`;function s({children:e}){let[s,n]=(0,r.useState)([]),[c,u]=(0,r.useState)(!0),[d,g]=(0,r.useState)(!1),[f,S]=(0,r.useState)(null),[h,m]=(0,r.useState)(null),[p,b]=(0,r.useState)(null),{tokens:y,userEmail:C,isLoading:v}=(0,a.useAuth)();(0,r.useEffect)(()=>{if(v)return;if(!C){n([]),m(null),u(!1);return}let e=o(C),t=localStorage.getItem(i),r=localStorage.getItem(e);if(t&&!r)try{let r=JSON.parse(t);localStorage.setItem(e,t),localStorage.removeItem(i),console.log(`Migrated subscription data to user-specific key: ${e}`),n(r.subscriptions||[]),m(r.lastScanAt||null)}catch(e){console.error("Failed to migrate legacy data",e)}else{let t=localStorage.getItem(e);if(t)try{let{subscriptions:e,lastScanAt:r}=JSON.parse(t);n(e||[]),m(r||null)}catch(e){console.error("Failed to parse subscriptions from storage",e)}}u(!1)},[C,v]),(0,r.useEffect)(()=>{if(!c&&C){let e=o(C);localStorage.setItem(e,JSON.stringify({subscriptions:s,lastScanAt:h}))}},[s,h,c,C]);let w=(0,r.useCallback)(e=>{let t=new Date().toISOString(),r={...e,id:crypto.randomUUID(),createdAt:t,updatedAt:t};n(e=>[...e,r])},[]),k=(0,r.useCallback)((e,t)=>{n(r=>r.map(r=>r.id===e?{...r,...t,updatedAt:new Date().toISOString()}:r))},[]),I=(0,r.useCallback)(e=>{n(t=>t.filter(t=>t.id!==e))},[]),A=(0,r.useCallback)(async e=>{if(y?.accessToken){g(!0),S({current:0,total:0});try{let t=await fetch("/api/gmail/scan",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessToken:y.accessToken,existingSubscriptions:s,periodDays:e})});if(!t.ok)throw Error("Scan failed");let r=await t.json();n(r.subscriptions),m(new Date().toISOString()),b(r.stats)}catch(e){console.error("Scan error:",e)}finally{g(!1),S(null)}}},[y,s]),O=(0,r.useCallback)(()=>s.filter(e=>"active"===e.status).reduce((e,t)=>"yearly"===t.billingCycle?e+t.amount/12:"quarterly"===t.billingCycle?e+t.amount/3:"weekly"===t.billingCycle?e+4*t.amount:e+t.amount,0),[s]),D=(0,r.useCallback)(()=>{let e={};return s.filter(e=>"active"===e.status).forEach(t=>{e[t.category]||(e[t.category]=[]),e[t.category].push(t)}),e},[s]),E=(0,r.useCallback)(e=>{let t=new Date,r=new Date;return r.setDate(r.getDate()+e),s.filter(e=>"active"===e.status).filter(e=>{let a=new Date(e.nextBillingDate);return a>=t&&a<=r}).sort((e,t)=>new Date(e.nextBillingDate).getTime()-new Date(t.nextBillingDate).getTime())},[s]),x=(0,r.useCallback)(()=>s.filter(e=>"active"===e.status),[s]);return(0,t.jsx)(l.Provider,{value:{subscriptions:s,isLoading:c,isScanning:d,scanProgress:f,lastScanAt:h,lastScanStats:p,addSubscription:w,updateSubscription:k,deleteSubscription:I,scanEmails:A,getTotalMonthlyAmount:O,getByCategory:D,getUpcomingRenewals:E,getActiveSubscriptions:x},children:e})}function n(){let e=(0,r.useContext)(l);if(void 0===e)throw Error("useSubscriptions must be used within a SubscriptionProvider");return e}e.s(["SubscriptionProvider",()=>s,"useSubscriptions",()=>n])},92518,e=>{"use strict";var t=e.i(43476),r=e.i(71645),a=e.i(57951);let l=(0,r.createContext)(null),i="cached_cancellation_guides",o=e=>`cancellation_guides_${e}`;function s({children:e}){let[s,n]=(0,r.useState)({}),[c,u]=(0,r.useState)(new Set),[d,g]=(0,r.useState)(!1),{userEmail:f,isLoading:S}=(0,a.useAuth)();(0,r.useEffect)(()=>{if(S)return;if(!f){n({}),g(!0);return}let e=o(f),t=localStorage.getItem(i),r=localStorage.getItem(e);if(t&&!r)try{localStorage.setItem(e,t),localStorage.removeItem(i),console.log(`Migrated cancellation guides to user-specific key: ${e}`),n(JSON.parse(t))}catch(e){console.error("Failed to migrate legacy guides:",e)}else try{let t=localStorage.getItem(e);t&&n(JSON.parse(t))}catch(e){console.error("Failed to load cached guides:",e)}g(!0)},[f,S]),(0,r.useEffect)(()=>{if(d&&f&&Object.keys(s).length>0)try{let e=o(f);localStorage.setItem(e,JSON.stringify(s))}catch(e){console.error("Failed to save cached guides:",e)}},[s,f,d]);let h=(0,r.useCallback)(async e=>{if(s[e])return s[e];if(c.has(e))return null;u(t=>new Set(t).add(e));try{let t=await fetch("/api/cancellation-guide",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({serviceName:e})});if(!t.ok){let e=await t.json();throw Error(e.error||"取得に失敗しました")}let{guide:r}=await t.json();return n(t=>({...t,[e]:r})),r}catch(e){throw console.error("Failed to fetch guide:",e),e}finally{u(t=>{let r=new Set(t);return r.delete(e),r})}},[s,c]),m=(0,r.useCallback)(e=>s[e],[s]),p=(0,r.useCallback)(e=>c.has(e),[c]);return(0,t.jsx)(l.Provider,{value:{cachedGuides:s,loadingServices:c,fetchGuide:h,getGuide:m,isLoading:p},children:e})}function n(){let e=(0,r.useContext)(l);if(!e)throw Error("useCancellationGuide must be used within CancellationGuideProvider");return e}e.s(["CancellationGuideProvider",()=>s,"useCancellationGuide",()=>n])}]);