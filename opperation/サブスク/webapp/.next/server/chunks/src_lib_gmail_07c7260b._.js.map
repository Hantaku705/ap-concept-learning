{"version":3,"sources":["../../../src/lib/gmail/client.ts","../../../node_modules/uuid/dist/esm/native.js","../../../node_modules/uuid/dist/esm/rng.js","../../../node_modules/uuid/dist/esm/regex.js","../../../node_modules/uuid/dist/esm/validate.js","../../../node_modules/uuid/dist/esm/stringify.js","../../../node_modules/uuid/dist/esm/v4.js","../../../src/data/service-patterns.ts","../../../src/lib/gmail/parser.ts"],"sourcesContent":["import { google, gmail_v1 } from 'googleapis';\nimport { getOAuth2Client } from '@/lib/auth/oauth';\n\n// 期間に応じた日付クエリを生成\nfunction getDateQuery(periodDays?: number): string {\n  if (!periodDays) {\n    return 'newer_than:1y'; // デフォルト: 過去1年\n  }\n\n  const today = new Date();\n  const startDate = new Date(today);\n  startDate.setDate(today.getDate() - periodDays);\n\n  // Gmail形式: after:YYYY/MM/DD\n  const year = startDate.getFullYear();\n  const month = String(startDate.getMonth() + 1).padStart(2, '0');\n  const day = String(startDate.getDate()).padStart(2, '0');\n\n  return `after:${year}/${month}/${day}`;\n}\n\n// PDF添付ファイル付き請求書メール（優先）\nfunction getPdfBillingQuery(periodDays?: number): string {\n  return [\n    'has:attachment filename:pdf',\n    'subject:(請求 OR 領収 OR お支払い OR invoice OR receipt OR 明細 OR ご利用)',\n    getDateQuery(periodDays),\n  ].join(' ');\n}\n\n// 通常の請求書メール\nfunction getBillingQuery(periodDays?: number): string {\n  return [\n    'subject:(請求 OR 領収 OR お支払い OR invoice OR receipt OR billing OR subscription OR サブスクリプション OR 月額)',\n    'from:(-no-reply@accounts.google.com)',  // Googleアカウント通知を除外\n    getDateQuery(periodDays),\n  ].join(' ');\n}\n\nexport async function createGmailClient(accessToken: string): Promise<gmail_v1.Gmail> {\n  const oauth2Client = getOAuth2Client();\n  oauth2Client.setCredentials({ access_token: accessToken });\n\n  return google.gmail({ version: 'v1', auth: oauth2Client });\n}\n\nexport async function searchEmails(\n  gmail: gmail_v1.Gmail,\n  query: string,\n  maxResults: number = 100\n): Promise<gmail_v1.Schema$Message[]> {\n  const response = await gmail.users.messages.list({\n    userId: 'me',\n    q: query,\n    maxResults,\n  });\n\n  return response.data.messages || [];\n}\n\nexport interface AttachmentInfo {\n  filename: string;\n  mimeType: string;\n  attachmentId?: string;\n}\n\nexport interface EmailContent {\n  id: string;\n  subject: string;\n  from: string;\n  date: string;\n  body: string;\n  hasPdfAttachment: boolean;\n  attachments: AttachmentInfo[];\n}\n\nexport async function getEmailContent(\n  gmail: gmail_v1.Gmail,\n  messageId: string\n): Promise<EmailContent | null> {\n  try {\n    const response = await gmail.users.messages.get({\n      userId: 'me',\n      id: messageId,\n      format: 'full',\n    });\n\n    const message = response.data;\n    const headers = message.payload?.headers || [];\n\n    const subject = headers.find(h => h.name?.toLowerCase() === 'subject')?.value || '';\n    const from = headers.find(h => h.name?.toLowerCase() === 'from')?.value || '';\n    const date = headers.find(h => h.name?.toLowerCase() === 'date')?.value || '';\n\n    // 添付ファイル情報を抽出\n    const attachments = extractAttachments(message.payload?.parts || []);\n    const hasPdfAttachment = attachments.some(a =>\n      a.mimeType === 'application/pdf' || a.filename.toLowerCase().endsWith('.pdf')\n    );\n\n    // 本文抽出\n    let body = '';\n    if (message.payload?.body?.data) {\n      body = Buffer.from(message.payload.body.data, 'base64').toString('utf-8');\n    } else if (message.payload?.parts) {\n      const textPart = findTextPart(message.payload.parts);\n      if (textPart?.body?.data) {\n        body = Buffer.from(textPart.body.data, 'base64').toString('utf-8');\n      }\n    }\n\n    // HTMLタグを除去\n    body = body.replace(/<[^>]*>/g, ' ').replace(/\\s+/g, ' ').trim();\n\n    return {\n      id: messageId,\n      subject,\n      from,\n      date,\n      body: body.slice(0, 5000), // 本文は5000文字まで\n      hasPdfAttachment,\n      attachments,\n    };\n  } catch (error) {\n    console.error('Failed to get email content:', messageId, error);\n    return null;\n  }\n}\n\n// 添付ファイル情報を再帰的に抽出（attachmentId含む）\nfunction extractAttachments(parts: gmail_v1.Schema$MessagePart[]): AttachmentInfo[] {\n  const attachments: AttachmentInfo[] = [];\n\n  for (const part of parts) {\n    if (part.filename && part.filename.length > 0) {\n      attachments.push({\n        filename: part.filename,\n        mimeType: part.mimeType || 'application/octet-stream',\n        attachmentId: part.body?.attachmentId || undefined,\n      });\n    }\n    if (part.parts) {\n      attachments.push(...extractAttachments(part.parts));\n    }\n  }\n\n  return attachments;\n}\n\n// 再帰的にtext/plainまたはtext/htmlパートを探す\nfunction findTextPart(parts: gmail_v1.Schema$MessagePart[]): gmail_v1.Schema$MessagePart | null {\n  for (const part of parts) {\n    if (part.mimeType === 'text/plain' || part.mimeType === 'text/html') {\n      return part;\n    }\n    if (part.parts) {\n      const found = findTextPart(part.parts);\n      if (found) return found;\n    }\n  }\n  return null;\n}\n\nexport async function scanForSubscriptions(\n  accessToken: string,\n  periodDays?: number,\n  onProgress?: (current: number, total: number) => void\n): Promise<EmailContent[]> {\n  const gmail = await createGmailClient(accessToken);\n\n  // PDF添付ファイル付きメールを優先的に取得\n  const pdfMessages = await searchEmails(gmail, getPdfBillingQuery(periodDays), 50);\n  const regularMessages = await searchEmails(gmail, getBillingQuery(periodDays), 50);\n\n  // 重複を除去してマージ（PDF優先）\n  const seenIds = new Set<string>();\n  const allMessages: gmail_v1.Schema$Message[] = [];\n\n  for (const msg of pdfMessages) {\n    if (msg.id && !seenIds.has(msg.id)) {\n      seenIds.add(msg.id);\n      allMessages.push(msg);\n    }\n  }\n  for (const msg of regularMessages) {\n    if (msg.id && !seenIds.has(msg.id)) {\n      seenIds.add(msg.id);\n      allMessages.push(msg);\n    }\n  }\n\n  const results: EmailContent[] = [];\n\n  for (let i = 0; i < allMessages.length; i++) {\n    const msg = allMessages[i];\n    if (msg.id) {\n      const content = await getEmailContent(gmail, msg.id);\n      if (content) {\n        results.push(content);\n      }\n    }\n    onProgress?.(i + 1, allMessages.length);\n  }\n\n  // PDF添付ファイル付きを先頭にソート\n  results.sort((a, b) => {\n    if (a.hasPdfAttachment && !b.hasPdfAttachment) return -1;\n    if (!a.hasPdfAttachment && b.hasPdfAttachment) return 1;\n    return 0;\n  });\n\n  return results;\n}\n","import { randomUUID } from 'crypto';\nexport default { randomUUID };\n","import { randomFillSync } from 'crypto';\nconst rnds8Pool = new Uint8Array(256);\nlet poolPtr = rnds8Pool.length;\nexport default function rng() {\n    if (poolPtr > rnds8Pool.length - 16) {\n        randomFillSync(rnds8Pool);\n        poolPtr = 0;\n    }\n    return rnds8Pool.slice(poolPtr, (poolPtr += 16));\n}\n","export default /^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;\n","import REGEX from './regex.js';\nfunction validate(uuid) {\n    return typeof uuid === 'string' && REGEX.test(uuid);\n}\nexport default validate;\n","import validate from './validate.js';\nconst byteToHex = [];\nfor (let i = 0; i < 256; ++i) {\n    byteToHex.push((i + 0x100).toString(16).slice(1));\n}\nexport function unsafeStringify(arr, offset = 0) {\n    return (byteToHex[arr[offset + 0]] +\n        byteToHex[arr[offset + 1]] +\n        byteToHex[arr[offset + 2]] +\n        byteToHex[arr[offset + 3]] +\n        '-' +\n        byteToHex[arr[offset + 4]] +\n        byteToHex[arr[offset + 5]] +\n        '-' +\n        byteToHex[arr[offset + 6]] +\n        byteToHex[arr[offset + 7]] +\n        '-' +\n        byteToHex[arr[offset + 8]] +\n        byteToHex[arr[offset + 9]] +\n        '-' +\n        byteToHex[arr[offset + 10]] +\n        byteToHex[arr[offset + 11]] +\n        byteToHex[arr[offset + 12]] +\n        byteToHex[arr[offset + 13]] +\n        byteToHex[arr[offset + 14]] +\n        byteToHex[arr[offset + 15]]).toLowerCase();\n}\nfunction stringify(arr, offset = 0) {\n    const uuid = unsafeStringify(arr, offset);\n    if (!validate(uuid)) {\n        throw TypeError('Stringified UUID is invalid');\n    }\n    return uuid;\n}\nexport default stringify;\n","import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\nfunction v4(options, buf, offset) {\n    if (native.randomUUID && !buf && !options) {\n        return native.randomUUID();\n    }\n    options = options || {};\n    const rnds = options.random ?? options.rng?.() ?? rng();\n    if (rnds.length < 16) {\n        throw new Error('Random bytes length must be >= 16');\n    }\n    rnds[6] = (rnds[6] & 0x0f) | 0x40;\n    rnds[8] = (rnds[8] & 0x3f) | 0x80;\n    if (buf) {\n        offset = offset || 0;\n        if (offset < 0 || offset + 16 > buf.length) {\n            throw new RangeError(`UUID byte range ${offset}:${offset + 15} is out of buffer bounds`);\n        }\n        for (let i = 0; i < 16; ++i) {\n            buf[offset + i] = rnds[i];\n        }\n        return buf;\n    }\n    return unsafeStringify(rnds);\n}\nexport default v4;\n","import { ServicePattern } from '@/types/subscription';\n\nexport const servicePatterns: ServicePattern[] = [\n  // Streaming\n  {\n    serviceName: 'Netflix',\n    senderPatterns: ['@netflix.com', '@mailer.netflix.com'],\n    subjectPatterns: ['Netflix.*請求', 'Netflix.*領収', 'お支払い.*Netflix', 'Netflix.*payment', 'Netflix.*receipt'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円', '\\\\$([\\\\d.]+)'],\n    category: 'streaming',\n    cancellationUrl: 'https://www.netflix.com/cancelplan',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/netflix.svg',\n  },\n  {\n    serviceName: 'Amazon Prime',\n    senderPatterns: ['@amazon.co.jp', '@amazon.com'],\n    subjectPatterns: ['Prime.*会費', 'Amazonプライム.*お支払い', 'Prime Video', 'Amazon Prime.*payment', 'プライム会費'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'streaming',\n    cancellationUrl: 'https://www.amazon.co.jp/gp/primecentral',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/amazonprime.svg',\n  },\n  {\n    serviceName: 'Spotify',\n    senderPatterns: ['@spotify.com'],\n    subjectPatterns: ['Spotify.*領収', 'Spotify Premium', 'お支払い.*Spotify', 'Spotify.*receipt'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円', '\\\\$([\\\\d.]+)'],\n    category: 'streaming',\n    cancellationUrl: 'https://support.spotify.com/jp/article/cancel-premium/',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/spotify.svg',\n  },\n  {\n    serviceName: 'YouTube Premium',\n    senderPatterns: ['@youtube.com', '@google.com', 'googleplay'],\n    subjectPatterns: ['YouTube Premium.*請求', 'YouTube.*お支払い', 'Google Play.*YouTube', 'YouTube Premium.*receipt'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'streaming',\n    cancellationUrl: 'https://support.google.com/youtube/answer/6308278',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/youtube.svg',\n  },\n  {\n    serviceName: 'Apple Music',\n    senderPatterns: ['@apple.com', '@email.apple.com'],\n    subjectPatterns: ['Apple Music.*領収', 'Apple.*サブスクリプション', 'App Store.*領収', 'Apple Music.*receipt'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'streaming',\n    cancellationUrl: 'https://support.apple.com/ja-jp/HT202039',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/applemusic.svg',\n  },\n  {\n    serviceName: 'Disney+',\n    senderPatterns: ['@disney', '@disneyplus.com'],\n    subjectPatterns: ['Disney\\\\+.*請求', 'Disney Plus.*payment', 'ディズニー.*お支払い'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円', '\\\\$([\\\\d.]+)'],\n    category: 'streaming',\n    cancellationUrl: 'https://www.disneyplus.com/account',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/disneyplus.svg',\n  },\n  {\n    serviceName: 'U-NEXT',\n    senderPatterns: ['@unext.jp', '@u-next.jp'],\n    subjectPatterns: ['U-NEXT.*請求', 'ユーネクスト.*お支払い', 'U-NEXT.*月額'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'streaming',\n    cancellationUrl: 'https://help.unext.jp/guide/detail/how-to-cancel',\n    logoUrl: '',\n  },\n  // Software/SaaS\n  {\n    serviceName: 'Adobe Creative Cloud',\n    senderPatterns: ['@adobe.com', '@adobemail.com'],\n    subjectPatterns: ['Adobe.*請求', 'Creative Cloud.*お支払い', 'Adobe.*領収', 'Adobe.*invoice'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円', '\\\\$([\\\\d.]+)'],\n    category: 'software',\n    cancellationUrl: 'https://helpx.adobe.com/jp/manage-account/using/cancel-subscription.html',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/adobe.svg',\n  },\n  {\n    serviceName: 'Microsoft 365',\n    senderPatterns: ['@microsoft.com', '@email.microsoft.com'],\n    subjectPatterns: ['Microsoft 365.*請求', 'Office.*サブスクリプション', 'Microsoft.*お支払い', 'Microsoft 365.*renewal'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'software',\n    cancellationUrl: 'https://support.microsoft.com/ja-jp/office/',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/microsoft.svg',\n  },\n  {\n    serviceName: 'Notion',\n    senderPatterns: ['@notion.so', '@makenotion.com'],\n    subjectPatterns: ['Notion.*invoice', 'Notion.*receipt', 'Notion.*billing', 'Notion.*請求'],\n    amountPatterns: ['\\\\$([\\\\d.]+)', '¥([\\\\d,]+)'],\n    category: 'software',\n    cancellationUrl: 'https://www.notion.so/help/billing-and-payment',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/notion.svg',\n  },\n  {\n    serviceName: 'Slack',\n    senderPatterns: ['@slack.com'],\n    subjectPatterns: ['Slack.*invoice', 'Slack.*receipt', 'Slack.*請求'],\n    amountPatterns: ['\\\\$([\\\\d.]+)', '¥([\\\\d,]+)'],\n    category: 'software',\n    cancellationUrl: 'https://slack.com/help/articles/218915077',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/slack.svg',\n  },\n  {\n    serviceName: 'ChatGPT Plus',\n    senderPatterns: ['@openai.com'],\n    subjectPatterns: ['ChatGPT.*receipt', 'OpenAI.*payment', 'ChatGPT Plus', 'OpenAI.*invoice'],\n    amountPatterns: ['\\\\$([\\\\d.]+)', '¥([\\\\d,]+)'],\n    category: 'software',\n    cancellationUrl: 'https://help.openai.com/en/articles/8546615',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/openai.svg',\n  },\n  {\n    serviceName: 'GitHub',\n    senderPatterns: ['@github.com'],\n    subjectPatterns: ['GitHub.*receipt', 'GitHub.*payment', 'GitHub Pro', 'GitHub.*invoice'],\n    amountPatterns: ['\\\\$([\\\\d.]+)', '¥([\\\\d,]+)'],\n    category: 'software',\n    cancellationUrl: 'https://docs.github.com/en/billing/managing-your-github-billing-settings',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/github.svg',\n  },\n  // Cloud Storage\n  {\n    serviceName: 'Google One',\n    senderPatterns: ['@google.com', '@googleplay.com'],\n    subjectPatterns: ['Google One.*請求', 'Google ストレージ.*お支払い', 'Google One.*領収', 'Google One.*receipt'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'cloud',\n    cancellationUrl: 'https://one.google.com/settings',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/google.svg',\n  },\n  {\n    serviceName: 'iCloud+',\n    senderPatterns: ['@apple.com', '@email.apple.com'],\n    subjectPatterns: ['iCloud.*領収', 'iCloud\\\\+.*お支払い', 'iCloud ストレージ', 'iCloud.*receipt'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'cloud',\n    cancellationUrl: 'https://support.apple.com/ja-jp/HT207594',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/icloud.svg',\n  },\n  {\n    serviceName: 'Dropbox',\n    senderPatterns: ['@dropbox.com', '@dropboxmail.com'],\n    subjectPatterns: ['Dropbox.*receipt', 'Dropbox.*invoice', 'Dropbox.*領収', 'Dropbox Plus', 'Dropbox Professional'],\n    amountPatterns: ['\\\\$([\\\\d.]+)', '¥([\\\\d,]+)'],\n    category: 'cloud',\n    cancellationUrl: 'https://help.dropbox.com/ja-jp/accounts-billing/cancellations-refunds/cancel',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/dropbox.svg',\n  },\n  // Gaming\n  {\n    serviceName: 'PlayStation Plus',\n    senderPatterns: ['@playstation.com', '@sony.com', 'playstation'],\n    subjectPatterns: ['PlayStation Plus.*請求', 'PS Plus.*お支払い', 'PlayStation.*領収', 'PlayStation Plus.*receipt'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'gaming',\n    cancellationUrl: 'https://www.playstation.com/ja-jp/support/store/cancel-ps-store-subscription/',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/playstation.svg',\n  },\n  {\n    serviceName: 'Nintendo Switch Online',\n    senderPatterns: ['@nintendo.com', '@nintendo.co.jp'],\n    subjectPatterns: ['Nintendo Switch Online.*請求', 'Nintendo.*お支払い', 'ニンテンドー.*月額'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'gaming',\n    cancellationUrl: 'https://www.nintendo.co.jp/support/switch/online/automatic_renewal.html',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/nintendoswitch.svg',\n  },\n  {\n    serviceName: 'Xbox Game Pass',\n    senderPatterns: ['@xbox.com', '@microsoft.com'],\n    subjectPatterns: ['Xbox Game Pass.*請求', 'Game Pass.*お支払い', 'Xbox.*サブスクリプション', 'Xbox Game Pass.*receipt'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'gaming',\n    cancellationUrl: 'https://support.xbox.com/ja-JP/help/subscriptions-billing/manage-subscriptions/cancel-subscription',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/xbox.svg',\n  },\n  // Fitness\n  {\n    serviceName: 'Apple Fitness+',\n    senderPatterns: ['@apple.com'],\n    subjectPatterns: ['Fitness\\\\+.*領収', 'Apple Fitness.*お支払い', 'Fitness\\\\+.*receipt'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'fitness',\n    cancellationUrl: 'https://support.apple.com/ja-jp/HT202039',\n    logoUrl: 'https://cdn.jsdelivr.net/npm/simple-icons@v9/icons/apple.svg',\n  },\n  // Marketing/Business Services\n  {\n    serviceName: 'SNS侍',\n    senderPatterns: ['sns-samurai', 'snssamurai', 'sns侍', 'snsmkt'],\n    subjectPatterns: ['SNS侍.*請求', 'SNS侍.*ご利用', '請求.*SNS侍', '.*SNS侍.*', 'ご請求.*侍'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円', '合計.*?([\\\\d,]+)円', '請求金額.*?([\\\\d,]+)'],\n    category: 'software',\n    cancellationUrl: '',\n    logoUrl: '',\n  },\n  // News\n  {\n    serviceName: '日経電子版',\n    senderPatterns: ['@nikkei.com', 'nikkei'],\n    subjectPatterns: ['日経電子版.*請求', '日経.*お支払い', '日本経済新聞.*月額'],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円'],\n    category: 'news',\n    cancellationUrl: 'https://www.nikkei.com/help/subscribe/cancel/',\n    logoUrl: '',\n  },\n  // Generic patterns for PDF invoices (priority)\n  {\n    serviceName: 'PDF Invoice',\n    senderPatterns: [],\n    subjectPatterns: [\n      '.*請求書',\n      '.*領収書',\n      '.*明細書',\n      '.*ご利用明細',\n      '.*invoice',\n      '.*receipt',\n      '.*statement',\n      '.*お支払い.*確認',\n      '.*ご請求',\n      '.*決済.*完了',\n    ],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円', '\\\\$([\\\\d.]+)', '€([\\\\d.]+)', '([\\\\d,]+)\\\\s*円'],\n    category: 'other',\n    isPdfPattern: true,\n  },\n  // Generic patterns for embedded invoices (HTML/text in body, no PDF required)\n  {\n    serviceName: 'Embedded Invoice',\n    senderPatterns: [],\n    subjectPatterns: [\n      '.*請求書.*',\n      '.*ご請求.*',\n      '.*請求のお知らせ.*',\n      '.*ご利用料金.*',\n      '.*お支払い.*のお知らせ',\n      '.*料金.*確定',\n      '.*月額.*請求',\n      '.*利用料.*お知らせ',\n    ],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円', '\\\\$([\\\\d.]+)', '€([\\\\d.]+)', '合計.*?([\\\\d,]+)', '請求金額.*?([\\\\d,]+)'],\n    category: 'other',\n    isEmbeddedInvoice: true,\n  },\n  // Generic patterns for unknown services\n  {\n    serviceName: 'Unknown Subscription',\n    senderPatterns: [],\n    subjectPatterns: [\n      '.*サブスクリプション.*請求',\n      '.*月額.*お支払い',\n      '.*定期購入.*領収',\n      '.*subscription.*invoice',\n      '.*monthly.*billing',\n      '.*recurring.*payment',\n      '.*自動更新.*お知らせ',\n    ],\n    amountPatterns: ['¥([\\\\d,]+)', '([\\\\d,]+)円', '\\\\$([\\\\d.]+)', '€([\\\\d.]+)'],\n    category: 'other',\n  },\n];\n","import { v4 as uuidv4 } from 'uuid';\nimport { servicePatterns } from '@/data/service-patterns';\nimport { Subscription, ServicePattern } from '@/types/subscription';\nimport { EmailContent } from '@/lib/gmail/client';\n\ninterface ParsedEmail {\n  id: string;\n  subject: string;\n  from: string;\n  date: string;\n  body: string;\n  hasPdfAttachment?: boolean;\n  attachments?: { filename: string; mimeType: string; attachmentId?: string }[];\n}\n\ninterface DetectedSubscription {\n  subscription: Partial<Subscription>;\n  confidence: number;        // 0-1\n  matchedPattern: ServicePattern;\n  rawEmail: ParsedEmail;\n}\n\nexport function parseEmail(email: ParsedEmail): DetectedSubscription | null {\n  const fromLower = email.from.toLowerCase();\n  const subjectLower = email.subject.toLowerCase();\n  const hasPdf = email.hasPdfAttachment || false;\n\n  for (const pattern of servicePatterns) {\n    // PDF専用パターンはPDF添付がある場合のみマッチ\n    if (pattern.isPdfPattern && !hasPdf) continue;\n\n    // 送信元マッチング\n    const senderMatch = pattern.senderPatterns.length === 0 ||\n      pattern.senderPatterns.some(p => fromLower.includes(p.toLowerCase()));\n\n    if (!senderMatch && pattern.senderPatterns.length > 0) continue;\n\n    // 件名マッチング\n    const subjectMatch = pattern.subjectPatterns.some(p => {\n      const regex = new RegExp(p, 'i');\n      return regex.test(email.subject);\n    });\n\n    if (!subjectMatch) continue;\n\n    // 金額抽出\n    const amount = extractAmount(email.body, pattern.amountPatterns) ||\n                   extractAmount(email.subject, pattern.amountPatterns);\n\n    // 請求日推定\n    const billingDate = extractDate(email.date);\n\n    // 信頼度計算\n    let confidence = 0.5;\n    if (senderMatch && pattern.senderPatterns.length > 0) confidence += 0.3;\n    if (subjectMatch) confidence += 0.1;\n    if (amount) confidence += 0.1;\n    if (hasPdf) confidence += 0.2; // PDF添付があれば信頼度UP\n\n    const now = new Date().toISOString();\n\n    // サービス名を決定\n    let serviceName = pattern.serviceName;\n    if (serviceName === 'Unknown Subscription' || serviceName === 'PDF Invoice' || serviceName === 'Embedded Invoice') {\n      serviceName = extractServiceName(email.from, email.subject, email.attachments);\n    }\n\n    // PDF添付ファイル情報を抽出\n    const pdfAttachments = email.attachments?.filter(a =>\n      a.filename.toLowerCase().endsWith('.pdf')\n    ) || [];\n    const pdfFilenames = pdfAttachments.map(a => a.filename);\n    const attachmentIds = pdfAttachments\n      .map(a => a.attachmentId)\n      .filter((id): id is string => !!id);\n\n    return {\n      subscription: {\n        id: uuidv4(),\n        serviceName,\n        category: pattern.category,\n        amount: amount || 0,\n        currency: 'JPY',\n        billingCycle: 'monthly',\n        nextBillingDate: calculateNextBillingDate(billingDate),\n        startDate: billingDate,\n        status: 'active',\n        source: 'gmail',\n        email: email.from,\n        senderEmail: email.from,\n        logoUrl: pattern.logoUrl,\n        cancellationUrl: pattern.cancellationUrl,\n        lastDetectedAt: now,\n        hasPdfAttachment: hasPdf,\n        pdfFilenames: pdfFilenames.length > 0 ? pdfFilenames : undefined,\n        emailSubject: email.subject,\n        messageId: email.id,\n        attachmentIds: attachmentIds.length > 0 ? attachmentIds : undefined,\n        emailBody: email.body.slice(0, 500), // 本文抜粋（500文字）\n        createdAt: now,\n        updatedAt: now,\n      },\n      confidence,\n      matchedPattern: pattern,\n      rawEmail: email,\n    };\n  }\n\n  return null;\n}\n\nfunction extractAmount(text: string, patterns: string[]): number | null {\n  for (const p of patterns) {\n    const regex = new RegExp(p, 'g');\n    const matches = text.matchAll(regex);\n    for (const match of matches) {\n      if (match[1]) {\n        const numStr = match[1].replace(/,/g, '');\n        const num = parseFloat(numStr);\n        if (!isNaN(num) && num > 0 && num < 1000000) {\n          return num;\n        }\n      }\n    }\n  }\n  return null;\n}\n\nfunction extractDate(dateString: string): string {\n  try {\n    const date = new Date(dateString);\n    if (!isNaN(date.getTime())) {\n      return date.toISOString().split('T')[0];\n    }\n  } catch {\n    // ignore\n  }\n  return new Date().toISOString().split('T')[0];\n}\n\nfunction extractServiceName(\n  from: string,\n  subject: string,\n  attachments?: { filename: string; mimeType: string }[]\n): string {\n  // 送信元の表示名を抽出（\"Company Name <email@example.com>\" 形式）\n  const displayNameMatch = from.match(/^([^<]+)</);\n  if (displayNameMatch) {\n    const displayName = displayNameMatch[1].trim();\n    if (displayName.length > 1 && displayName.length < 50) {\n      return displayName;\n    }\n  }\n\n  // ドメインからサービス名を推測\n  const domainMatch = from.match(/@([^.]+)\\./);\n  if (domainMatch) {\n    const name = domainMatch[1];\n    // 一般的なドメインは除外\n    if (!['gmail', 'yahoo', 'outlook', 'hotmail', 'noreply', 'no-reply', 'mail'].includes(name.toLowerCase())) {\n      return name.charAt(0).toUpperCase() + name.slice(1);\n    }\n  }\n\n  // PDF添付ファイル名から推測\n  if (attachments) {\n    for (const att of attachments) {\n      if (att.filename.toLowerCase().endsWith('.pdf')) {\n        // ファイル名から日付や番号を除去してサービス名を抽出\n        const cleanName = att.filename\n          .replace(/\\.pdf$/i, '')\n          .replace(/[_-]?\\d{4,}/g, '')  // 日付・番号除去\n          .replace(/[_-]/g, ' ')\n          .trim();\n        if (cleanName.length > 2 && cleanName.length < 50) {\n          return cleanName;\n        }\n      }\n    }\n  }\n\n  // 件名から推測\n  const words = subject.split(/[\\s　]+/).filter(w => w.length > 2);\n  if (words.length > 0) {\n    return words[0];\n  }\n\n  return 'Unknown Service';\n}\n\nfunction calculateNextBillingDate(lastBillingDate: string): string {\n  const date = new Date(lastBillingDate);\n  date.setMonth(date.getMonth() + 1);\n  return date.toISOString().split('T')[0];\n}\n\nexport function mergeDetectedSubscriptions(\n  existing: Subscription[],\n  detected: DetectedSubscription[]\n): { merged: Subscription[]; newCount: number; updatedCount: number } {\n  const result = [...existing];\n  let newCount = 0;\n  let updatedCount = 0;\n\n  // サービス名でグループ化（重複除去）\n  const groupedDetected = new Map<string, DetectedSubscription>();\n  for (const det of detected) {\n    const key = det.subscription.serviceName?.toLowerCase() || '';\n    const existing = groupedDetected.get(key);\n    // より新しいものを優先\n    if (!existing || (det.rawEmail.date > existing.rawEmail.date)) {\n      groupedDetected.set(key, det);\n    }\n  }\n\n  for (const det of groupedDetected.values()) {\n    // 同じサービスが既に存在するか確認\n    const existingIndex = result.findIndex(\n      s => s.serviceName.toLowerCase() === det.subscription.serviceName?.toLowerCase()\n    );\n\n    if (existingIndex >= 0) {\n      // 更新（PDF関連フィールドも含む）\n      result[existingIndex] = {\n        ...result[existingIndex],\n        amount: det.subscription.amount || result[existingIndex].amount,\n        nextBillingDate: det.subscription.nextBillingDate || result[existingIndex].nextBillingDate,\n        lastDetectedAt: det.subscription.lastDetectedAt,\n        // PDF/メール関連フィールドを更新\n        hasPdfAttachment: det.subscription.hasPdfAttachment || result[existingIndex].hasPdfAttachment,\n        pdfFilenames: det.subscription.pdfFilenames || result[existingIndex].pdfFilenames,\n        messageId: det.subscription.messageId || result[existingIndex].messageId,\n        attachmentIds: det.subscription.attachmentIds || result[existingIndex].attachmentIds,\n        emailSubject: det.subscription.emailSubject || result[existingIndex].emailSubject,\n        emailBody: det.subscription.emailBody || result[existingIndex].emailBody,\n        senderEmail: det.subscription.senderEmail || result[existingIndex].senderEmail,\n        updatedAt: new Date().toISOString(),\n      };\n      updatedCount++;\n    } else {\n      // 新規追加\n      result.push(det.subscription as Subscription);\n      newCount++;\n    }\n  }\n\n  return { merged: result, newCount, updatedCount };\n}\n"],"names":[],"mappings":"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","ignoreList":[1,2,3,4,5,6]}