# code - Google Apps Script インサイト自動取得

Google Apps Script（GAS）で書かれた、SNS投稿のインサイトデータを自動取得するスクリプト。

---

## ファイル一覧

| ファイル | 説明 |
|---------|------|
| `code.js` | GASメインスクリプト（1,208行） |

---

## 機能概要

Googleスプレッドシートに入力されたSNS投稿URLから、各プラットフォームの**再生数・いいね・コメント数**などを自動取得してシートに書き込む。

### 対応プラットフォーム

| SNS | API | 速度 | 取得データ |
|-----|-----|------|-----------|
| **YouTube** | YouTube Data API（公式） | ~0.2秒 | タイトル、再生数、いいね、コメント、動画尺 |
| **TikTok** | RapidAPI (tiktok-video-downloader-api) | ~2秒 | タイトル、再生数、いいね、コメント、共有、保存、動画尺 |
| **Instagram** | RapidAPI (instagram-scraper-stable-api) | ~2秒 | キャプション、再生数、いいね、コメント、動画尺 |
| **X(Twitter)** | RapidAPI (twitter241) | ~1.5秒 | テキスト、表示回数、いいね、リプライ、RT、ブックマーク |

---

## 主要機能

### 1. メニュー追加
スプレッドシート「インサイト自動入力」メニュー:
- 今すぐ実行（このシート / 指定シート）
- SNS別実行（YouTube / TikTok / Instagram / X のみ）
- 毎日9時の自動実行設定/解除

### 2. タイムアウト対策
GASの6分制限に対応:
- 5.5分で自動中断
- 状態を`ScriptProperties`に保存
- 1分後に自動再開トリガーを作成

### 3. 処理順ソート
効率的な処理順序:
1. TikTok → YouTube → Instagram → X（API速度順）
2. 更新日が空白 → 日付古い順 → エラー行は最後

### 4. スキップ条件
- 48時間以内に更新済み → スキップ
- 「エラー」と記載 → 手動削除まで再取得しない
- URLが空白 → スキップ
- 対象外SNS → スキップ（`allowedSns`フィルター時）

---

## 処理順序の詳細

### SNS優先度

| 優先度 | SNS | 値 | 理由 |
|--------|-----|-----|------|
| 1位 | TikTok | 0 | RapidAPI直接取得（~2秒） |
| 2位 | YouTube | 1 | 公式API（~0.2秒、最速だが2番目） |
| 3位 | Instagram | 2 | RapidAPI直接取得（~2秒） |
| 4位 | X(Twitter) | 3 | RapidAPI直接取得（~1.5秒） |

**関数**: `getSnsPriority_()` (1098-1101行目)

### 更新日優先度

同じSNS内では更新日でソート:

| 優先度 | 条件 | 値 |
|--------|------|-----|
| 最優先 | 更新日が**空白** | 0 |
| 中間 | 日付あり（**古い順**） | タイムスタンプ値 |
| 最後 | 「**エラー**」と記載 | Infinity |

**関数**: `getUpdatedAtPriority_()` (1103-1111行目)

### 処理フロー

```
1. シートからデータ取得（行21〜最終行）
          ↓
2. URL有り行を抽出
          ↓
3. ソート（TT→YT→IG→X、空白→日付古い→エラー）
          ↓
4. 各行をループ
   ├─ 48時間以内？ → スキップ
   ├─ 「エラー」？ → スキップ
   └─ API呼び出し → シート書き込み → flush
          ↓
5. 5.5分超過？ → 中断＆1分後再開トリガー
          ↓
6. 完了
```

### タイムアウト対策フロー

```
開始 → 5.5分経過 → 中断 → 状態保存 → 1分後自動再開 → 続きから処理
```

**保存される状態**:
- `sheetName`: シート名
- `lastSortIdx`: 最後に処理したソートインデックス
- `allowedSns`: 対象SNSフィルター
- `timestamp`: 中断時刻

---

## 設定

```javascript
SHEET: '1月',           // 対象シート名
START_ROW: 21,          // データ開始行
URL_COL: 7,             // URL列（G列）
UPDATE_INTERVAL_MS: 48 * 60 * 60 * 1000,  // 48時間間隔
MAX_EXECUTION_MS: 5.5 * 60 * 1000,        // 最大実行5.5分
DAILY_TRIGGER_HOUR: 9   // 毎日9時実行
```

---

## カラム構成（A〜O列）

| 列 | 内容 |
|----|------|
| A | 投稿日 |
| B | アカウント名 |
| C | PR/通常 |
| D | SNS |
| E | 担当者 |
| F | タイトル |
| G | **URL** ← 読み取り元 |
| H | 種別 |
| I | **更新日** ← 自動更新 |
| J | 動画尺 |
| K | **再生数** |
| L | **いいね** |
| M | **コメント** |
| N | **共有** |
| O | **保存** |

---

## 使い方

1. スプレッドシートにURLを入力（G列）
2. メニュー「インサイト自動入力」→「今すぐ実行」
3. 各SNSのAPIからデータを取得してシートに反映

---

## 設定

### RapidAPI Key

```javascript
RAPIDAPI_KEY: '64b6e140fa...'  // TikTok / Instagram / X 共用
```

スクリプト内にハードコードされている（本番運用では`ScriptProperties`に移すべき）。

---

## 注意事項

- RapidAPIキーがコード内にハードコードされている
- TikTok: フォールバックで公式Web APIも試行
- YouTube: GASのYouTube Data APIサービスを使用（APIキー不要）
- Instagram: レート制限対策で2秒待機 + 最大3回リトライ（3秒→6秒→9秒間隔）

---

## 更新履歴

- 2026-01-26: Instagramレート制限対策追加（2秒待機 + 最大3回リトライ、+26行）
- 2026-01-26: Instagramバッチ取得（Apify）を廃止、TikTok/YouTubeと同じ個別RapidAPI取得に統一（-31行）
- 2026-01-26: 処理順序・ルールの詳細ドキュメント追加（SNS優先度、更新日優先度、処理フロー図）
- 2026-01-26: 全API高速化（TikTok→tiktok-video-downloader-api、IG→instagram-scraper-stable-api、X→twitter241、Apify廃止）
- 2026-01-26: 初版作成（code.jsの理解・ドキュメント化）
