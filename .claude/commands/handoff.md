# /handoff - セッション終了時の書き出し

セッション終了時に進捗を HANDOFF.md に**追記**し、コアな実装内容は CLAUDE.md にも反映します。

## 重要：追記型の更新

**HANDOFF.mdは上書きではなく追記で更新する。** 既存の内容を維持しつつ、今回のセッションの変更だけを追加する。

---

## アーカイブ判定（自動実行）

### 実行タイミング
HANDOFF.md読み込み後、更新前に自動実行

### 判定ロジック
1. HANDOFF.mdの文字数を取得
2. 推定トークン数 = 文字数 / 3（日本語向け）
3. **20,000トークン超過時 → アーカイブ処理を実行**

### アーカイブ処理手順
1. 「## セッション履歴」セクションを抽出
2. 直近10セッション以外をHANDOFF_ARCHIVE.mdに追記
3. 完了タスクをサマリーテーブルに変換（フェーズ別集計）
4. HANDOFF.mdを圧縮版で上書き

### 圧縮後のHANDOFF.md構成
```markdown
# HANDOFF - セッション引き継ぎ

## 現在の状態

### 完了したタスク（サマリー）
| フェーズ | 期間 | 主要タスク | 件数 |
|---------|------|-----------|------|
| 初期設計 | 1-10回目 | ... | N件 |
詳細は [HANDOFF_ARCHIVE.md](./HANDOFF_ARCHIVE.md) を参照。

### 作業中のタスク
- [ ] ...

## セッション履歴（直近10回分）
### YYYY-MM-DD（N回目）
...

---
過去のセッション履歴: [HANDOFF_ARCHIVE.md](./HANDOFF_ARCHIVE.md)
```

### スキップ条件
- 推定トークン数 ≤ 20,000
- アーカイブ対象セッションなし（直近10回のみ）

---

## 実行手順

1. git status で変更ファイルを確認
2. git log -1 で最新コミットを確認
3. **HANDOFF.md を読み込み**、既存の内容を確認
4. **[自動] アーカイブ判定を実行**（上記参照）
5. **HANDOFF.md を追記更新**（既存内容を維持）:
   - 完了したタスク → 既存リストに**追加**
   - 作業中のタスク → 完了したものは完了に移動、新規は追加
   - 未コミット変更 → 最新のgit statusで**更新**
   - 最新コミット → 最新のgit logで**更新**
   - セッション履歴 → 今回のセッションを**先頭に追加**
6. **プロジェクト内CLAUDE.mdの自動更新**（詳細は後述）:
   a. `git status --short` で変更ファイル・フォルダを特定
   b. 変更ファイルの**全ディレクトリパス**を抽出（重複除去）
   c. 各ディレクトリに対して**必ず**:
      - CLAUDE.mdが**存在しない** → **新規作成**（テンプレート使用）
      - CLAUDE.mdが**存在する** → **ファイル一覧・更新履歴を更新**
   d. 親フォルダ→ルートの順でCLAUDE.mdを連鎖更新

   **注意**: CLAUDE.mdがないフォルダは必ず作成する。既存のCLAUDE.mdがある場合のみ更新ではなく、**全変更フォルダにCLAUDE.mdを保証**する。
7. **ルートCLAUDE.md を更新**（永続的なプロジェクト知識）
8. **コミット＆プッシュ**（オプション）

---

## CLAUDE.md 自動更新ルール

### 検出ロジック

1. `git status --short` で変更ファイルを取得
2. 変更ファイルの**全ディレクトリパス**を抽出（重複除去）
3. 各ディレクトリについて:
   - **CLAUDE.mdが存在しない → 新規作成**
   - **CLAUDE.mdが存在する → 更新**
4. 親ディレクトリを辿り、ルートまでの CLAUDE.md も対象に追加（なければ作成）

**原則**: 変更ファイルがあるフォルダには**必ず**CLAUDE.mdを配置する。

### 更新対象の判定

| 条件 | アクション |
|------|-----------|
| **フォルダにCLAUDE.mdなし + 任意のファイル変更** | **CLAUDE.md新規作成** |
| フォルダにCLAUDE.mdあり + ファイル変更あり | ファイル一覧を更新 |
| 親フォルダのCLAUDE.md | サブフォルダ一覧を更新 |
| ルートCLAUDE.md | 更新履歴に追記 |

**重要**: `.md`ファイルだけでなく、`.ts`, `.tsx`, `.json`, `.pdf`, `.csv` 等すべてのファイル変更を対象とする。

### 除外対象

以下のフォルダ・ファイルはCLAUDE.md自動更新の対象外：

- `.git/`
- `node_modules/`
- `.claude/commands/`（スキル定義）
- `.claude/agents/`（サブエージェント定義）
- `HANDOFF.md`
- `README.md`

### シンプルなCLAUDE.mdテンプレート

**新規作成時**:

```markdown
# [フォルダ名] - [1行説明]

## ファイル一覧

| ファイル | 説明 |
|---------|------|
| `file1.md` | [概要] |
| `file2.pdf` | [概要] |

## 更新履歴

- YYYY-MM-DD: 初版作成
```

**既存更新時**:
- ファイル一覧テーブルに新規ファイルを追加
- 更新履歴に変更内容を追記（1行）

### 連鎖更新の例

```
プロジェクト/
├── CLAUDE.md              ← 3. ルート更新（更新履歴に追記）
├── docs/
│   ├── CLAUDE.md          ← 2. 親フォルダ更新（サブフォルダ一覧）
│   └── research/
│       ├── CLAUDE.md      ← 1. 直接フォルダ更新（ファイル一覧）
│       └── analysis.md    ← 今回作成したファイル
```

---

## 更新パターン

### 完了したタスク（追加）

```diff
 - [x] 既存のタスク1
 - [x] 既存のタスク2
+- [x] **今回完了したタスク**
```

### セッション履歴（先頭に追加）

```diff
 ## セッション履歴

+### YYYY-MM-DD
+- 今回やったこと1
+- 今回やったこと2
+
 ### 前回の日付
 - 前回やったこと
```

### 未コミット変更（上書き）

```markdown
## 未コミット変更
```
[最新の git status --short の出力]
```
```

### 最新コミット（上書き）

```markdown
## 最新コミット
```
[最新の git log -1 --oneline の出力]
```
```

---

## .md ファイルのフォルダ化ルール

### 原則

**各 .md ファイルは専用フォルダに格納し、同フォルダ内に CLAUDE.md を配置する。**

### 構造

```
[parent]/
├── CLAUDE.md              ← 親フォルダの説明
└── [filename]/            ← ファイル専用フォルダ
    ├── [filename].md      ← コンテンツ
    └── CLAUDE.md          ← このファイルの説明
```

### 例

```
research/keywords/
├── CLAUDE.md              ← keywords/ 全体の説明
└── sns-keywords/
    ├── sns-keywords.md    ← KW設計書
    └── CLAUDE.md          ← sns-keywords.md の説明
```

### 例外（フォルダ化しない）

- `HANDOFF.md`（ルート直下）
- `CLAUDE.md`（各フォルダ直下）
- `README.md`
- `.claude/commands/*.md`（スキル定義）
- `.claude/agents/*.md`（サブエージェント定義）

---

## CLAUDE.md 更新ガイドライン

### ファイル専用 CLAUDE.md の記載内容

新しい `.md` ファイルを作成したら、そのファイル専用フォルダ内に CLAUDE.md を作成する。

```markdown
# [filename].md - [1行説明]

## ファイル一覧

| ファイル | 説明 |
|---------|------|
| `[filename].md` | [概要] |

## 更新履歴

- YYYY-MM-DD: 初版作成
```

### 親フォルダ CLAUDE.md の記載内容

ファイル専用フォルダを作成したら、親フォルダの CLAUDE.md も更新する。

```markdown
# [フォルダ名]/ - [1行説明]

## サブフォルダ一覧

| フォルダ | 説明 |
|---------|------|
| `[subfolder]/` | [説明] |

## ファイル一覧

| ファイル | 説明 |
|---------|------|
| `file.md` | [概要] |

## 更新履歴

- YYYY-MM-DD: 変更内容
```

### ルートCLAUDE.md 更新すべき内容

| セッションで行ったこと          | 更新先セクション         |
| ------------------------------- | ------------------------ |
| 新しいページ/コンポーネント追加 | Key Files                |
| 新しいAPIエンドポイント追加     | API Routes               |
| 新しいスキル追加                | カスタムスキル           |
| 新しいDB関数追加                | Common Patterns          |
| バグ修正（重要なもの）          | 解決済みの課題           |
| 新しい環境変数追加              | 環境変数                 |
| DBスキーマ変更                  | データベーススキーマ     |
| ハマったポイント                | よくある間違いと修正     |
| **新しいフォルダ追加**          | **フォルダ構成**         |
| **新しいプロジェクト追加**      | **プロジェクト一覧**     |

### 更新しない内容

- 一時的な作業状態（HANDOFF.mdに記載）
- 未確定の設計（確定後に追加）
- 些細な修正（typo修正など）

---

## 注意事項

- **絶対に既存の完了タスクを削除しない**
- **セッション履歴は日付順（新しい順）で蓄積**
- 未コミット変更がある場合は git stash を提案
- 次のアクションは具体的に記載
- 問題は原因と対応方針も含める
- CLAUDE.md の更新は永続的な知識のみ
- **CLAUDE.mdは上書きではなく追記で更新**（既存内容を維持）
